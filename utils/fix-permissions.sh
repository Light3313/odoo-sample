#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∞–≤–∏–ª—å–Ω–∏—Ö –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É –¥–ª—è Odoo

# –û—Ç—Ä–∏–º—É—î–º–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é —Å–∫—Ä–∏–ø—Ç–∞
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(cd "${SCRIPT_DIR}/.." && pwd)"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é –ø—Ä–æ–µ–∫—Ç—É
cd "${PROJECT_DIR}"

echo "üîß –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É –¥–ª—è Odoo..."
echo ""

# Odoo –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∞—Ü—é—î –ø—ñ–¥ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º odoo (UID 101)
# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–∞–≤–∞ —Ç–∞–∫, —â–æ–± –≤—Å—ñ –º–æ–≥–ª–∏ —á–∏—Ç–∞—Ç–∏, –∞–ª–µ —Ç—ñ–ª—å–∫–∏ –≤–ª–∞—Å–Ω–∏–∫ –º–æ–∂–µ –ø–∏—Å–∞—Ç–∏
# –¶–µ –¥–æ–∑–≤–æ–ª–∏—Ç—å Odoo —á–∏—Ç–∞—Ç–∏ —Ñ–∞–π–ª–∏ –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ UID –Ω–∞ —Ö–æ—Å—Ç—ñ

# –ü–∞–ø–∫–∏, —è–∫—ñ –ø–æ—Ç—Ä—ñ–±–Ω–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏
DIRS=(
    "addons"
    "config"
    "logs"
)

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–∞–≤–∞ –¥–ª—è –ø–∞–ø–æ–∫
for dir in "${DIRS[@]}"; do
    if [ -d "${dir}" ]; then
        echo "üìÅ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–∞–≤ –¥–ª—è ${dir}/..."
        # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–∞–≤–∞ 755 –¥–ª—è –ø–∞–ø–æ–∫ (rwxr-xr-x)
        find "${dir}" -type d -exec chmod 755 {} \;
        # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–∞–≤–∞ 644 –¥–ª—è —Ñ–∞–π–ª—ñ–≤ (rw-r--r--)
        find "${dir}" -type f -exec chmod 644 {} \;
        # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–∞–≤–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –¥–ª—è .sh —Ñ–∞–π–ª—ñ–≤
        find "${dir}" -type f -name "*.sh" -exec chmod 755 {} \;
        echo "   ‚úÖ –ì–æ—Ç–æ–≤–æ"
    else
        echo "‚ö†Ô∏è  –ü–∞–ø–∫–∞ ${dir}/ –Ω–µ —ñ—Å–Ω—É—î, –ø—Ä–æ–ø—É—Å–∫–∞—é..."
    fi
done

# –°–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ –ø—Ä–∞–≤–∞ –¥–ª—è Python —Ñ–∞–π–ª—ñ–≤
if [ -d "addons" ]; then
    echo ""
    echo "üêç –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–∞–≤ –¥–ª—è Python —Ñ–∞–π–ª—ñ–≤..."
    find addons -type f -name "*.py" -exec chmod 644 {} \;
    find addons -type f -name "__init__.py" -exec chmod 644 {} \;
    echo "   ‚úÖ –ì–æ—Ç–æ–≤–æ"
fi

# –°—Ç–≤–æ—Ä—é—î–º–æ –ø–∞–ø–∫–∏, —è–∫—â–æ —ó—Ö –Ω–µ–º–∞—î
mkdir -p logs
mkdir -p backups
mkdir -p output

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–∞–≤–∞ –¥–ª—è –Ω–æ–≤–∏—Ö –ø–∞–ø–æ–∫
chmod 777 logs 2>/dev/null || true  # 777 –¥–ª—è logs, —â–æ–± Odoo –º—ñ–≥ –ø–∏—Å–∞—Ç–∏
chmod 755 backups output 2>/dev/null || true

# –°—Ç–≤–æ—Ä—é—î–º–æ —Ñ–∞–π–ª –ª–æ–≥—É, —è–∫—â–æ –π–æ–≥–æ –Ω–µ–º–∞—î, –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º–∏ –ø—Ä–∞–≤–∞–º–∏
if [ ! -f "logs/odoo.log" ]; then
    touch logs/odoo.log
    chmod 666 logs/odoo.log  # rw-rw-rw- —â–æ–± Odoo –º—ñ–≥ –ø–∏—Å–∞—Ç–∏
    echo "üìù –°—Ç–≤–æ—Ä–µ–Ω–æ —Ñ–∞–π–ª –ª–æ–≥—É: logs/odoo.log"
fi

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –≤–ª–∞—Å–Ω–∏–∫–∞ –¥–ª—è –ª–æ–≥—ñ–≤ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (—è–∫—â–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω–∏–π)
if docker compose ps web 2>/dev/null | grep -q "Up"; then
    echo ""
    echo "üê≥ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –≤–ª–∞—Å–Ω–∏–∫–∞ –¥–ª—è –ª–æ–≥—ñ–≤ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
    docker compose exec -T web chown -R odoo:odoo /var/log/odoo 2>/dev/null || {
        echo "   ‚ö†Ô∏è  –ù–µ –≤–¥–∞–ª–æ—Å—è –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –≤–ª–∞—Å–Ω–∏–∫–∞ (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –º–æ–∂–µ –±—É—Ç–∏ –Ω–µ –≥–æ—Ç–æ–≤–∏–π)"
        echo "   üí° –°–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É: docker compose exec web chown -R odoo:odoo /var/log/odoo"
    }
    echo "   ‚úÖ –ì–æ—Ç–æ–≤–æ"
fi

echo ""
echo "‚úÖ –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!"
echo ""
echo "üí° –Ø–∫—â–æ Odoo –≤—Å–µ —â–µ –Ω–µ –±–∞—á–∏—Ç—å –º–æ–¥—É–ª—ñ, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ:"
echo "   1. –ß–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤–∫–∞–∑–∞–Ω–∏–π —à–ª—è—Ö –≤ config/odoo.conf"
echo "   2. –ß–∏ –≤—Å—ñ –º–æ–¥—É–ª—ñ –º–∞—é—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É (__init__.py, __manifest__.py)"
echo "   3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏: docker compose restart"

#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–∫–∏–¥–∞–Ω–Ω—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö (–¥–ª—è —Ä–æ–∑—Ä–æ–±–∫–∏)

set -e

# –û—Ç—Ä–∏–º—É—î–º–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é —Å–∫—Ä–∏–ø—Ç–∞
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(cd "${SCRIPT_DIR}/.." && pwd)"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é –ø—Ä–æ–µ–∫—Ç—É
cd "${PROJECT_DIR}"

# –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑–º—ñ–Ω–Ω—ñ –∑ .env —Ñ–∞–π–ª—É, —è–∫—â–æ –≤—ñ–Ω —ñ—Å–Ω—É—î
if [ -f .env ]; then
    export $(cat .env | grep -v '^#' | xargs)
fi

# –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
DB_USER=${DB_USER:-odoo}
DB_PASSWORD=${DB_PASSWORD:-odoo}

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∑–∞–ø—É—â–µ–Ω—ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏
if ! docker compose ps | grep -q "db.*Up"; then
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –±–∞–∑–∏ –¥–∞–Ω–∏—Ö –Ω–µ –∑–∞–ø—É—â–µ–Ω–∏–π!"
    echo "   –ó–∞–ø—É—Å—Ç—ñ—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏: docker compose up -d"
    exit 1
fi

# –Ø–∫—â–æ –Ω–∞–∑–≤–∞ –ë–î –ø–µ—Ä–µ–¥–∞–Ω–∞ —è–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —ó—ó
if [ -n "$1" ]; then
    DB_NAME="$1"
else
    # –û—Ç—Ä–∏–º—É—î–º–æ —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –±–∞–∑ –¥–∞–Ω–∏—Ö (–≤–∏–∫–ª—é—á–∞—î–º–æ —Å–∏—Å—Ç–µ–º–Ω—ñ)
    AVAILABLE_DBS=$(docker compose exec -T db psql -U "${DB_USER}" -lqt 2>/dev/null | \
        cut -d \| -f 1 | \
        sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//' | \
        grep -vE '^(template[0-9]|postgres)$' | \
        grep -v '^$' | \
        sort)
    
    if [ -z "$AVAILABLE_DBS" ]; then
        echo "‚ùå –ü–æ–º–∏–ª–∫–∞: –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –±–∞–∑ –¥–∞–Ω–∏—Ö Odoo!"
        echo "   –°—Ç–≤–æ—Ä—ñ—Ç—å –±–∞–∑—É –¥–∞–Ω–∏—Ö —á–µ—Ä–µ–∑ –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å Odoo"
        exit 1
    fi
    
    # –Ø–∫—â–æ —Ç—ñ–ª—å–∫–∏ –æ–¥–Ω–∞ –ë–î, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —ó—ó
    DB_COUNT=$(echo "$AVAILABLE_DBS" | grep -v '^$' | wc -l)
    if [ "$DB_COUNT" -eq 1 ]; then
        DB_NAME=$(echo "$AVAILABLE_DBS" | grep -v '^$' | head -1)
        echo "üì¶ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é –±–∞–∑—É –¥–∞–Ω–∏—Ö: ${DB_NAME}"
    else
        # –ü–æ–∫–∞–∑—É—î–º–æ —Å–ø–∏—Å–æ–∫ —ñ –ø–∏—Ç–∞—î–º–æ
        echo "üìã –î–æ—Å—Ç—É–ø–Ω—ñ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö Odoo:"
        echo ""
        echo "$AVAILABLE_DBS" | grep -v '^$' | nl -w2 -s'. '
        echo ""
        
        # –Ø–∫—â–æ —î –¥–µ—Ñ–æ–ª—Ç–Ω–∞ –∑ .env, –ø—Ä–æ–ø–æ–Ω—É—î–º–æ —ó—ó
        DEFAULT_DB=${DB_NAME:-postgres}
        if echo "$AVAILABLE_DBS" | grep -qw "$DEFAULT_DB"; then
            read -p "–í–∏–±–µ—Ä—ñ—Ç—å –±–∞–∑—É –¥–∞–Ω–∏—Ö –¥–ª—è —Å–∫–∏–¥–∞–Ω–Ω—è [Enter –¥–ª—è '${DEFAULT_DB}']: " DB_NAME
            DB_NAME=${DB_NAME:-$DEFAULT_DB}
        else
            read -p "–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –±–∞–∑–∏ –¥–∞–Ω–∏—Ö –¥–ª—è —Å–∫–∏–¥–∞–Ω–Ω—è: " DB_NAME
        fi
        
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —ñ—Å–Ω—É—î –≤–∏–±—Ä–∞–Ω–∞ –ë–î
        if ! echo "$AVAILABLE_DBS" | grep -qw "$DB_NAME"; then
            echo "‚ùå –ü–æ–º–∏–ª–∫–∞: –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö '${DB_NAME}' –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞!"
            echo "   –î–æ—Å—Ç—É–ø–Ω—ñ –±–∞–∑–∏: $(echo "$AVAILABLE_DBS" | grep -v '^$' | tr '\n' ' ')"
            exit 1
        fi
    fi
    echo ""
fi

echo "‚ö†Ô∏è  –£–í–ê–ì–ê: –¶–µ–π —Å–∫—Ä–∏–ø—Ç –≤–∏–¥–∞–ª–∏—Ç—å –≤—Å—ñ –¥–∞–Ω—ñ –∑ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö!"
echo "   –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö: ${DB_NAME}"
echo ""
echo "–¶–µ –æ–ø–µ—Ä–∞—Ü—ñ—è –ù–ï–ó–í–û–†–û–¢–ù–ê! –í—Å—ñ –¥–∞–Ω—ñ –±—É–¥—É—Ç—å –≤—Ç—Ä–∞—á–µ–Ω—ñ."
read -p "–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ? –í–≤–µ–¥—ñ—Ç—å 'DELETE' –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è: " confirm

if [ "$confirm" != "DELETE" ]; then
    echo "‚ùå –û–ø–µ—Ä–∞—Ü—ñ—é —Å–∫–∞—Å–æ–≤–∞–Ω–æ."
    exit 0
fi

# –ó—É–ø–∏–Ω—è—î–º–æ Odoo –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
echo "üõë –ó—É–ø–∏–Ω—è—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä Odoo..."
docker compose stop web

# –í–∏–¥–∞–ª—è—î–º–æ —Ç–∞ —Å—Ç–≤–æ—Ä—é—î–º–æ –±–∞–∑—É –¥–∞–Ω–∏—Ö –∑–∞–Ω–æ–≤–æ
echo "üóëÔ∏è  –í–∏–¥–∞–ª–µ–Ω–Ω—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö..."
docker compose exec -T db psql -U "${DB_USER}" -d postgres -c "DROP DATABASE IF EXISTS ${DB_NAME};"

echo "üÜï –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ—ó –±–∞–∑–∏ –¥–∞–Ω–∏—Ö..."
docker compose exec -T db psql -U "${DB_USER}" -d postgres -c "CREATE DATABASE ${DB_NAME};"

if [ $? -eq 0 ]; then
    echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö —É—Å–ø—ñ—à–Ω–æ —Å–∫–∏–Ω—É—Ç–∞!"
    echo ""
    echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä Odoo..."
    docker compose start web
    echo ""
    echo "üìã –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏:"
    echo "   1. –í—ñ–¥–∫—Ä–∏–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä: http://localhost:${ODOO_PORT:-8069}"
    echo "   2. –°—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤—É –±–∞–∑—É –¥–∞–Ω–∏—Ö '${DB_NAME}' —á–µ—Ä–µ–∑ –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å"
    echo "   3. –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –º–æ–¥—É–ª—ñ"
else
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å–∫–∏–¥–∞–Ω–Ω—ñ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö!"
    docker compose start web
    exit 1
fi

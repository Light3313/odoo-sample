#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö –∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ—ó –∫–æ–ø—ñ—ó

set -e

# –û—Ç—Ä–∏–º—É—î–º–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é —Å–∫—Ä–∏–ø—Ç–∞
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(cd "${SCRIPT_DIR}/.." && pwd)"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é –ø—Ä–æ–µ–∫—Ç—É
cd "${PROJECT_DIR}"

# –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑–º—ñ–Ω–Ω—ñ –∑ .env —Ñ–∞–π–ª—É, —è–∫—â–æ –≤—ñ–Ω —ñ—Å–Ω—É—î
if [ -f .env ]; then
    export $(cat .env | grep -v '^#' | xargs)
fi

# –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
DB_USER=${DB_USER:-odoo}
DB_PASSWORD=${DB_PASSWORD:-odoo}
DB_HOST=${DB_HOST:-db}

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç—ñ–≤
if [ -z "$1" ]; then
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞: –ù–µ –≤–∫–∞–∑–∞–Ω–æ —Ñ–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ—ó –∫–æ–ø—ñ—ó!"
    echo ""
    echo "–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:"
    echo "  ./utils/restore-db.sh <backup_file> [–Ω–∞–∑–≤–∞_–±–∞–∑–∏_–¥–∞–Ω–∏—Ö]"
    echo ""
    echo "–ü—Ä–∏–∫–ª–∞–¥:"
    echo "  ./utils/restore-db.sh backups/odoo_backup_postgres_20250116_120000.sql.gz"
    echo "  ./utils/restore-db.sh backups/odoo_backup_postgres_20250116_120000.sql.gz my_odoo_db"
    echo ""
    echo "–î–æ—Å—Ç—É–ø–Ω—ñ —Ä–µ–∑–µ—Ä–≤–Ω—ñ –∫–æ–ø—ñ—ó:"
    ls -lh "${PROJECT_DIR}/backups"/*.sql.gz 2>/dev/null | tail -5 || echo "  (–Ω–µ–º–∞—î —Ä–µ–∑–µ—Ä–≤–Ω–∏—Ö –∫–æ–ø—ñ–π)"
    exit 1
fi

BACKUP_FILE="$1"

# –Ø–∫—â–æ —à–ª—è—Ö –≤—ñ–¥–Ω–æ—Å–Ω–∏–π, —Ä–æ–±–∏–º–æ –π–æ–≥–æ –∞–±—Å–æ–ª—é—Ç–Ω–∏–º –≤—ñ–¥–Ω–æ—Å–Ω–æ –ø—Ä–æ–µ–∫—Ç—É
if [[ ! "$BACKUP_FILE" = /* ]]; then
    BACKUP_FILE="${PROJECT_DIR}/${BACKUP_FILE}"
fi

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ —Ñ–∞–π–ª—É
if [ ! -f "${BACKUP_FILE}" ]; then
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞: –§–∞–π–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ: ${BACKUP_FILE}"
    echo ""
    echo "–î–æ—Å—Ç—É–ø–Ω—ñ —Ä–µ–∑–µ—Ä–≤–Ω—ñ –∫–æ–ø—ñ—ó:"
    ls -lh "${PROJECT_DIR}/backups"/*.sql.gz 2>/dev/null | tail -5 || echo "  (–Ω–µ–º–∞—î —Ä–µ–∑–µ—Ä–≤–Ω–∏—Ö –∫–æ–ø—ñ–π)"
    exit 1
fi

echo "üîÑ –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö –∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ—ó –∫–æ–ø—ñ—ó..."
echo "   –§–∞–π–ª: ${BACKUP_FILE}"
echo "   –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö: ${DB_NAME}"
echo ""
echo "‚ö†Ô∏è  –£–í–ê–ì–ê: –¶—è –æ–ø–µ—Ä–∞—Ü—ñ—è –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ –ø–æ—Ç–æ—á–Ω—É –±–∞–∑—É –¥–∞–Ω–∏—Ö!"
read -p "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏? (yes/no): " confirm

if [ "$confirm" != "yes" ]; then
    echo "‚ùå –û–ø–µ—Ä–∞—Ü—ñ—é —Å–∫–∞—Å–æ–≤–∞–Ω–æ."
    exit 0
fi

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∑–∞–ø—É—â–µ–Ω—ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏
if ! docker compose ps | grep -q "db.*Up"; then
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –±–∞–∑–∏ –¥–∞–Ω–∏—Ö –Ω–µ –∑–∞–ø—É—â–µ–Ω–∏–π!"
    echo "   –ó–∞–ø—É—Å—Ç—ñ—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏: docker compose up -d"
    exit 1
fi

# –í–∏–∑–Ω–∞—á–∞—î–º–æ –Ω–∞–∑–≤—É –ë–î –∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –∞–±–æ –≤–∏–±–∏—Ä–∞—î–º–æ
if [ -n "$2" ]; then
    DB_NAME="$2"
else
    # –û—Ç—Ä–∏–º—É—î–º–æ —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –±–∞–∑ –¥–∞–Ω–∏—Ö (–≤–∏–∫–ª—é—á–∞—î–º–æ —Å–∏—Å—Ç–µ–º–Ω—ñ)
    AVAILABLE_DBS=$(docker compose exec -T db psql -U "${DB_USER}" -lqt 2>/dev/null | \
        cut -d \| -f 1 | \
        sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//' | \
        grep -vE '^(template[0-9]|postgres)$' | \
        grep -v '^$' | \
        sort)
    
    if [ -z "$AVAILABLE_DBS" ]; then
        # –Ø–∫—â–æ –Ω–µ–º–∞—î –ë–î, –ø–∏—Ç–∞—î–º–æ –Ω–∞–∑–≤—É –¥–ª—è –Ω–æ–≤–æ—ó
        read -p "–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –±–∞–∑–∏ –¥–∞–Ω–∏—Ö –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è: " DB_NAME
        if [ -z "$DB_NAME" ]; then
            echo "‚ùå –ü–æ–º–∏–ª–∫–∞: –ù–∞–∑–≤–∞ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö –æ–±–æ–≤'—è–∑–∫–æ–≤–∞!"
            exit 1
        fi
    else
        # –Ø–∫—â–æ —Ç—ñ–ª—å–∫–∏ –æ–¥–Ω–∞ –ë–î, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —ó—ó
        DB_COUNT=$(echo "$AVAILABLE_DBS" | grep -v '^$' | wc -l)
        if [ "$DB_COUNT" -eq 1 ]; then
            DB_NAME=$(echo "$AVAILABLE_DBS" | grep -v '^$' | head -1)
            echo "üì¶ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é –±–∞–∑—É –¥–∞–Ω–∏—Ö: ${DB_NAME}"
        else
            # –ü–æ–∫–∞–∑—É—î–º–æ —Å–ø–∏—Å–æ–∫ —ñ –ø–∏—Ç–∞—î–º–æ
            echo "üìã –î–æ—Å—Ç—É–ø–Ω—ñ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö Odoo:"
            echo ""
            echo "$AVAILABLE_DBS" | grep -v '^$' | nl -w2 -s'. '
            echo ""
            read -p "–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –±–∞–∑–∏ –¥–∞–Ω–∏—Ö –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è (–∞–±–æ –Ω–æ–≤—É –Ω–∞–∑–≤—É): " DB_NAME
            if [ -z "$DB_NAME" ]; then
                echo "‚ùå –ü–æ–º–∏–ª–∫–∞: –ù–∞–∑–≤–∞ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö –æ–±–æ–≤'—è–∑–∫–æ–≤–∞!"
                exit 1
            fi
        fi
    fi
    echo ""
fi

# –ó—É–ø–∏–Ω—è—î–º–æ Odoo –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–¥ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è–º
echo "üõë –ó—É–ø–∏–Ω—è—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä Odoo..."
docker compose stop web

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —ñ—Å–Ω—É—î –ë–î, —è–∫—â–æ –Ω—ñ - —Å—Ç–≤–æ—Ä—é—î–º–æ
if ! docker compose exec -T db psql -U "${DB_USER}" -lqt | cut -d \| -f 1 | grep -qw "${DB_NAME}"; then
    echo "üÜï –°—Ç–≤–æ—Ä—é—é –±–∞–∑—É –¥–∞–Ω–∏—Ö: ${DB_NAME}..."
    docker compose exec -T db psql -U "${DB_USER}" -d postgres -c "CREATE DATABASE ${DB_NAME};"
fi

# –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –±–∞–∑—É –¥–∞–Ω–∏—Ö
echo "üì• –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö..."
gunzip -c "${BACKUP_FILE}" | docker compose exec -T db psql -U "${DB_USER}" -d "${DB_NAME}"

if [ $? -eq 0 ]; then
    echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–∞!"
    echo ""
    echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä Odoo..."
    docker compose start web
    echo "‚úÖ –ì–æ—Ç–æ–≤–æ!"
else
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—ñ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö!"
    echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä Odoo..."
    docker compose start web
    exit 1
fi

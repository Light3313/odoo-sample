#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –≤—Ö–æ–¥—É –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä PostgreSQL

# –û—Ç—Ä–∏–º—É—î–º–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é —Å–∫—Ä–∏–ø—Ç–∞
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(cd "${SCRIPT_DIR}/.." && pwd)"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é –ø—Ä–æ–µ–∫—Ç—É
cd "${PROJECT_DIR}"

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∑–∞–ø—É—â–µ–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
if ! docker compose ps | grep -q "db.*Up"; then
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä PostgreSQL –Ω–µ –∑–∞–ø—É—â–µ–Ω–∏–π!"
    echo "   –ó–∞–ø—É—Å—Ç—ñ—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏: docker compose up -d"
    exit 1
fi

# –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑–º—ñ–Ω–Ω—ñ –∑ .env —Ñ–∞–π–ª—É, —è–∫—â–æ –≤—ñ–Ω —ñ—Å–Ω—É—î
if [ -f .env ]; then
    export $(cat .env | grep -v '^#' | xargs)
fi

DB_NAME=${DB_NAME:-postgres}
DB_USER=${DB_USER:-odoo}

echo "üêö –í—Ö—ñ–¥ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä PostgreSQL..."
echo "   –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö: ${DB_NAME}"
echo "   –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: ${DB_USER}"
echo "   –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ 'exit' –¥–ª—è –≤–∏—Ö–æ–¥—É"
echo ""
echo "üí° –ö–æ—Ä–∏—Å–Ω—ñ –∫–æ–º–∞–Ω–¥–∏:"
echo "   \\l          - –°–ø–∏—Å–æ–∫ –±–∞–∑ –¥–∞–Ω–∏—Ö"
echo "   \\c ${DB_NAME}  - –ü—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö"
echo "   \\dt         - –°–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü—å"
echo "   \\q          - –í–∏–π—Ç–∏ –∑ psql"
echo ""

# –í—Ö–æ–¥–∏–º–æ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑ psql
docker compose exec db psql -U "${DB_USER}" -d "${DB_NAME}"
